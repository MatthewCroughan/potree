<!DOCTYPE html>
<html lang="en">
<head>
	<title>LAS.NIX.HOW</title>
<script>

// To run locally copy build directory across and then run caddy, and add reference to the converter
// caddy file-server . --listen 0.0.0.0:9002 
// http://127.0.0.1:9002/repositories/potree/examples/remote_fetching_frontend_blank.html?potreeprocessor=http://100.107.23.115:8000/

const getParams = function(url) {
    var vars = { };
    let link = document.createElement('a');
    link.href = url;
    let query = link.search.substring(1);
    let parameters = query.split('&');
    for (let i = 0; i < parameters.length; i++) {
        let pair = parameters[i].split('=');
        vars[pair[0]] = decodeURIComponent(pair[1]);
    }
    link.hash = ""; 
    link.search = "";
    link.pathname = link.pathname.substring(0, link.pathname.lastIndexOf('/')+1); 
    vars["urldirpath"] = link.href;
    link.pathname = "";
    vars["baseurl"] = link.href;
    if (!("potreeprocessor" in vars)) {
        vars["potreeprocessor"] = vars["baseurl"];
    }
    return vars;
};

var currbackground = ""; 
var params = {};
var fileuploadhash = "";
function setfiledragoverfunctions(paper1el)
{
    paper1el.style.visibility = "visible"; 
    paper1el.ondragover = function(e) {  e.stopPropagation(); e.preventDefault(); }; 
    paper1el.ondragenter = function(e) {
        e.stopPropagation(); e.preventDefault(); 
        currbackground = paper1el.style.background; 
        paper1el.style.background = "#ffa"; 
    };
    paper1el.ondragleave = function(e) {
        e.stopPropagation(); e.preventDefault(); 
        paper1el.style.background = currbackground;
        currbackground = "";  
    }; 
    paper1el.ondrop = function(e) {
        e.stopPropagation(); e.preventDefault(); 
        paper1el.style.background = currbackground;
        currbackground = "";  
        uploadprocesslaz(e.dataTransfer.files, paper1el); 
    };
    
    document.getElementById("realupload").onchange = function(e) {
        uploadprocesslaz(this.files, paper1el); 
    }
    
    document.getElementById("gobutton").onclick = interprettypedcode;
    document.getElementById("choosefilebutton").onclick = function(e) { 
        document.getElementById("realupload").click(); 
    };
    
    document.getElementById("shortcode").addEventListener('keypress', function(e) {
        if (e.keyCode === 13) {
            e.preventDefault();
            interprettypedcode(e);
        } else {
            //window.location.search = document.getElementById("shortcode").value;
            //window.history.pushState("object or string", "Title", "/new-url");
        }
    });
}

function uploadprocesslaz(files)
{
    if (files.length != 1) {
        alert("Only one file at a time"); 
        return; 
    }
    let f = files[0]; 
    if (!f.name.match(/\.(las|laz|zip)$/gi)) {
        alert("Only las, laz or zipped laz files allowed"); 
        return; 
    }
    document.getElementById("realupload").style.opacity = 0.0;
    console.log("uploadprocesslaz", f.name); 
    var reader = new FileReader();
    var progressboxbar = document.getElementById("progressboxbar"); 
    var filedroppanelmsg = document.getElementById("filedroppanelmsg"); 
    reader.onload = uploadloadedlaz;
    reader.readAsArrayBuffer(f);
}

function interpretshortcode(potreedataurl)
{
    console.log("Shortcode: "+shortcode); 
    var rfurl = params["urldirpath"] + "remote_fetching_frontend.html";
    var metadataurl = potreedataurl + "/metadata.json";
    window.location.href = rfurl + "?metadata=" + encodeURIComponent(metadataurl); 
}

function interpretresponsecode(response)
{
    console.log("RESPONSE:" + response); 
    if (response == 0) {
        filedroppanelmsg.textContent = "Failed"; 
        return;
    }
    let link = document.createElement('a');
    link.href = response;
    link.hash = ""; 
    link.search = "";
    let resphashcode = link.pathname.substring(link.pathname.lastIndexOf('/')+1); 
    if (resphashcode != fileuploadhash) {
        console.log("Warning: respond hashcode differs from filehash, "+resphashcode)
    }
    link.pathname = "";
    if (params["potreeprocessor"] != link.href) {
        console.log("Warning: respond domain differs from potreeprocessor, "+link.href);
    }
    interpretshortcode(response); 
}

async function interprettypedcode(e) 
{
    var ppotreedataurl = params["potreeprocessor"] + document.getElementById("shortcode").value;
    try {
    var res = null;
    await $.ajax({
        url: ppotreedataurl+"/metadata.json",
        crossDomain: true,
        type: "GET",
        success: function (data) {
            res = data;
        },
        error: function (qXHR, textStatus, errorThrown) {
            console.log(textStatus);
            console.log(errorThrown);
        }
    });
    } catch(e) { console.log("Caught error: "+e); };
    if (res != null) {
        filedroppanelmsg.textContent = "Redirecting"; 
        setTimeout(interpretshortcode, 1000, ppotreedataurl);
        return; 
    }
    filedroppanelmsg.textContent = "Code not present"; 
}


async function uploadloadedlaz(event)
{
    console.log(event); 
    var result = event.target.result;   
    console.log("File Length: " + result.byteLength); 
    filedroppanelmsg.textContent = "Calculating HASH"; 
    if (window.crypto.subtle != undefined) {
        var hashBuffer = await window.crypto.subtle.digest("SHA-256", result); 
        var hashArray = Array.from(new Uint8Array(hashBuffer));
        fileuploadhash = hashArray.map((item) => item.toString(16).padStart(2, "0")).join("");
        console.log("Hashcode of file: "+fileuploadhash);
        document.getElementById("shortcode").value = fileuploadhash.substring(0, 3);
        var ppotreedataurl = params["potreeprocessor"]+fileuploadhash;
        filedroppanelmsg.textContent = "Checking uploads"; 
        var res = null;
        try {
        await $.ajax({
            url: ppotreedataurl+"/metadata.json",
            crossDomain: true,
            type: "GET",
            success: function (data) {
                res = data;
            },
            error: function (err) {
                console.log(err);
            }
        });
        } catch(e) { console.log("Caught error: "+e); };
        if (res != null) {
            filedroppanelmsg.textContent = "Already uploaded, redirecting"; 
            setTimeout(interpretshortcode, 1000, ppotreedataurl);
            return; 
        }
    } else {
        document.getElementById("shortcode").value = "---";
    }
    
    fileuploadhash
    
    filedroppanelmsg.textContent = "Uploading"; 
    var req = $.ajax({
        url: params["potreeprocessor"],
        data: result,
        crossDomain: true,
        processData: false,
        type: "POST",
        async: true,
        contentType: "application/x-www-form-urlencoded", 
        success: interpretresponsecode,
        xhr: function () {
            var xhr = $.ajaxSettings.xhr();
            xhr.upload.onprogress = function (e) {
                if (e.lengthComputable) {
                    var proportionuploaded = e.loaded / e.total;
                    progressboxbar.style.width = (proportionuploaded*100) + "%";
                    if (proportionuploaded >= 0.999) {
                        filedroppanelmsg.textContent = "Processing"; 
                    }
                }
            };
            return xhr;
        }, 
    });
}

window.onload = function() {
    params = getParams(window.location.href); 
    setfiledragoverfunctions(document.getElementById("filedroppanel")); 
    if ("shortcode" in params) {
        document.getElementById("shortcode").value = params["shortcode"];
        interprettypedcode();
    }
};

</script>
<style>
    h1 { text-align: center; }
    div#filedroppanel { position: absolute; width: 80%; height: 80%; left: 10%; top: 10%; background: #7eb3de80; z-index: 10; 
                        text-align: center; line-height: 4.5em; }
    #filedroppanelmsg { font-size: 3em; }
    #browsefileform { }
    
    #fshortcode { font-size: 2em; }
    #shortcode { font-size: 1.4em; }

    #gobutton { font-size: 1.4em; }
    #choosefilebutton { font-size: 2.4em; }
    #realupload { display: none; }
    
    div#progressbox { width: 60%; height: 2em; margin-left:20%; margin-right:20%; margin-top: 1em; margin-bottom: 1em; border: thin black solid; }
    div#progressboxbar { width: 0%; background-color: black; height: 100%; }
    

    p#tagline { font-size: 20px; font-style: italic; }
    p#tagline img { position: relative; top:0.4em; }
    #browsefileform input[type="file"] { font-size: 2.1em; }
</style>

</head>

<body>
	<script src="../libs/jquery/jquery-3.1.1.min.js"></script>
	<script src="../libs/jquery-ui/jquery-ui.min.js"></script>
    <h1>Point Cloud Viewer</h1>
	<div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
		<div id="filedroppanel">
            <div id="filedroppanelmsg">Browse or drag-and-drop laz/zip file here</div>
            <form id="browsefileform">
                <button type="button" id="choosefilebutton">Choose file...</button>
                <input type="file" name="upload" id="realupload" />
            </form>
            <div id="progressbox"><div id="progressboxbar"></div></div>
            <form id="fshortcode">
                Or enter shortcode: <input type="text" id="shortcode" size="4" />
                <button type="button" id="gobutton">Go</button>
            </form>
            <p id="tagline">Service developed and hosted by <a href="https://nix.how/">Nix.How Limited 
                <img src="https://images.spr.so/cdn-cgi/imagedelivery/j42No7y-dcokJuNgXeA0ig/6a9b3988-e8e5-41e8-a58a-3aade6a21582/nix.how/w=40,quality=80"/>
            </a></p>
        </div>
	</div>
	
	
  </body>
</html>
